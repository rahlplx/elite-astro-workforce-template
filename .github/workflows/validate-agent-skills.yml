name: Validate Agent Skills

on:
  push:
    branches: [ main ]
    paths:
      - '.agent/skills/**'
      - '.agent/workflows/**'
      - '.agent/orchestration/**'
  pull_request:
    branches: [ main ]
    paths:
      - '.agent/skills/**'
      - '.agent/workflows/**'
      - '.agent/orchestration/**'

jobs:
  validate-skills:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .agent

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: .agent/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Validate Skills Structure
      run: npx tsx scripts/validate-skills.ts

    - name: TypeScript Check
      run: npx tsc --noEmit

    - name: Lint Check
      run: npm run lint --if-present

  validate-orchestration:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .agent

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: .agent/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Verify Router
      run: npx tsx scripts/verify-router.ts

    - name: Test Learning System
      run: npx tsx scripts/test-learning.ts

  generate-report:
    runs-on: ubuntu-latest
    needs: [validate-skills, validate-orchestration]
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Generate Validation Report
      run: |
        echo "## Agent Workforce Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Skills Validation: ${{ needs.validate-skills.result }}" >> $GITHUB_STEP_SUMMARY
        echo "### Orchestration Validation: ${{ needs.validate-orchestration.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "Generated at: $(date -u)" >> $GITHUB_STEP_SUMMARY
